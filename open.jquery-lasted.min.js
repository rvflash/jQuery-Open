/**
 * jQuery Open plugin
 *
 * @desc Enable to open links in iframe with loading message, in ajax, in current view or in a new window
 * @version 1.3.3
 * @author Herv√© GOUCHET
 * @use jQuery 1.7+
 * @licenses Creative Commons BY-SA 2.0
 * @see https://github.com/rvflash/jQuery-Open
 * @note Now use Event as only one parameter passed to callback methods.
 *       Event has new property currentHref with url decoded as string inside
 */
(function(g){var c={data:{base:null,id:"_openid",loaded:"_openloaded",loading:"_openloading"},type:{base:null,self:"self",blank:"blank",iframe:"iframe",ajax:"ajax"},popup:{height:780,width:420},uniqueIdentifier:"unique",visibleIdentifier:"visible",notOutIdentifier:"notouter"};var f={type:c.type.self,container:"body",autoload:false,browser:{name:"_openbrowser",error:{name:"_openfailure",content:"An error was occured. Please to retry later.",enable:true},closure:{name:"_close",content:"X",enable:false},loading:{name:"_openloader",content:"Please be patient, loading ...",enable:true},displayInline:false,outerClosure:false,maxTab:5},ajax:{toggle:true,onLoaded:null,onView:null,onExit:null},iframe:{options:{src:"",scrolling:"auto",frameborder:0},onLoaded:null,onView:null,onExit:null},popup:{options:{scrollbars:"yes",toolbar:"yes",location:"yes",directories:"yes",menubar:"yes",resizable:"yes",status:"yes",top:0,left:0,height:780,width:420},onExit:null},window:{onExit:null}};var h=function(r,p){r.preventDefault();r=g.extend(true,{},r);var q=g(r.currentTarget);if(null==q.data(c.data.id)){q.data(c.data.id,"_open"+Math.floor((Math.random()*1001)+1))}c.data.base=q.data(c.data.id);if(q.hasClass(c.type.self)){c.type.base=c.type.self}else{if(q.hasClass(c.type.blank)){c.type.base=c.type.blank}else{if(q.hasClass(c.type.iframe)){c.type.base=c.type.iframe}else{if(q.hasClass(c.type.ajax)){c.type.base=c.type.ajax}else{c.type.base=p.type}}}}if(null!=(r.currentHref=n(q,p))){switch(c.type.base){case c.type.ajax:return i(r,p);case c.type.iframe:return m(r,p);case c.type.blank:return e(r,p);case c.type.self:default:return j(r,p)}}return false};var o=function(r,q){if(g.isFunction(q[c.type.base].onExit)){q[c.type.base].onExit(r)}g(r.currentTab).hide().removeClass(c.visibleIdentifier);var p=g("#"+q.browser.name);if(0==p.children("."+c.visibleIdentifier).length){p.removeClass(c.data.loaded)}};var k=function(t,s,q){var p=g(t.target);var r=g("#"+q.browser.name+" div."+c.visibleIdentifier);if(0<r.length&&0==p.closest("."+c.notOutIdentifier).length){s=p.parents(s).first();if(0<s.length){p=s}if(null==(s=p.data(c.data.id))){s=g("#"+s)}if(0==s.length&&p[0]!=r[0]&&0==p.parents("#"+r.attr("id")).length){if(r.children("iframe").length){c.type.base=c.type.iframe}else{c.type.base=c.type.ajax}t.currentTab=r[0];o(t,q)}}};var i=function(q,p){if(null==g("#"+p.name).data(c.data.loading)){a(p);if(null==g("#"+c.data.base).data(c.data.loaded)){g("#"+p.name).data(c.data.loading,true);return g.get(q.currentHref,function(r){g("#"+p.name).data(c.data.loading,false);g("#"+c.data.base).append(r)}).success(function(){l(q,p)}).error(function(){if(p.browser.error.enable){g("#"+p.browser.error.name).show().delay(1000).hide()}})}return l(q,p)}};var m=function(t,r){a(r);if(null==g("#"+c.data.base).data(c.data.loaded)){var p=[];for(var s in r.iframe.options){p.push(s+' = "'+r.iframe.options[s]+'"')}g("#"+c.data.base).append("<iframe "+p.join(" ")+"></iframe>")}var q=g("#"+c.data.base+" > iframe");if(r.browser.loading.enable){if(""==q.attr("src")){return q.attr("src",t.currentHref).load(function(){l(t,r)})}}else{if(""==q.attr("src")){q.attr("src",t.currentHref)}}return l(t,r)};var e=function(s,q){var t=[];var p=q.popup.options;p.height=(screen.height*0.8);p.width=(screen.width*0.8);if(p.width<c.popup.height){p.height=c.popup.height}if(p.height<c.popup.width){p.width=c.popup.width}for(var r in p){t.push(r+"="+p[r])}if(g.isFunction(q.popup.onExit)){q.popup.onExit(q.popup.name)}return window.open(s.currentHref,c.data.base,t.join(","))};var j=function(q,p){if(g.isFunction(p.window.onExit)){p.window.onExit(q)}return window.location.href=q.currentHref};var a=function(r){if(0==g("#"+r.browser.name).length){g(document.body).append('<div id="'+r.browser.name+'"></div>')}if(r.browser.loading.enable){if(0==g("#"+r.browser.loading.name).length){g(document.body).append('<div id="'+r.browser.loading.name+'">'+r.browser.loading.content+"</div>")}else{g("#"+r.browser.loading.name).show()}}if(r.browser.error.enable){if(0==g("#"+r.browser.error.name).length){g(document.body).append('<div id="'+r.browser.error.name+'">'+r.browser.error.content+"</div>")}g("#"+r.browser.error.name).hide()}if(0==g("#"+c.data.base).length){var q=g("#"+r.browser.name+" > div");if(r.browser.maxTab<=q.length){q.filter(":first").remove()}var p="";if(r.browser.closure.enable){p='<div class="'+r.browser.closure.name+'">'+r.browser.closure.content+"</div>"}g("#"+r.browser.name).append('<div id="'+c.data.base+'">'+p+"</div>")}g("#"+r.browser.name+" > div").hide()};var l=function(r,p){if(p.browser.loading.enable){g("#"+p.browser.loading.name).hide()}var q=g("#"+c.data.base);r.currentTab=q[0];if(c.type.ajax==c.type.base&&p.ajax.toggle&&q.hasClass(c.visibleIdentifier)){o(r,p)}else{g("#"+p.browser.name).addClass(c.data.loaded);if(p.browser.displayInline){q.show()}else{q.css("display","block")}q.addClass(c.visibleIdentifier);if(null==q.data(c.data.loaded)){if(g.isFunction(p[c.type.base].onLoaded)){p[c.type.base].onLoaded(r)}q.data(c.data.loaded,true)}if(g.isFunction(p[c.type.base].onView)){p[c.type.base].onView(r)}}};var d=function(u){var r=new String();var q,p,v,t=new String();q="a";p="A";v="z";t="Z";var s=-1,w;while(s++<u.length-1){w=u.charCodeAt(s);if(w>=q.charCodeAt()&&w<=v.charCodeAt()){w=((w-q.charCodeAt()+13)%26)+q.charCodeAt()}else{if(w>=p.charCodeAt()&&w<=t.charCodeAt()){w=((w-p.charCodeAt()+13)%26)+p.charCodeAt()}}r+=String.fromCharCode(w)}return r};var n=function(r,q){var p;if(null!=(p=b(r))){if(c.type.ajax==c.type.base&&-1!=p.indexOf("#")){p=p.replace("#",(-1!=p.indexOf("?")?"&":"?"))}if(null!=r.data("arg")){p+=(-1!=p.indexOf("?")?"&":"?")+r.data("arg")}if(r.hasClass(c.uniqueIdentifier)){p+=(-1!=p.indexOf("?")?"&":"?")+"_i="+new Date().getTime()}}return p};var b=function(q){if("undefined"!==typeof q.attr("href")){return q.attr("href")}else{if("undefined"!==typeof q.data("url")){return q.data("url")}else{if("undefined"!==typeof q.data("erl")){return d(q.data("erl"))}else{if("undefined"!==typeof q.data("nrl")){var p=q.data("nrl");if(-1!==p.indexOf("uggc:")||-1!==p.indexOf("uggcf:")){return d(p)}return p}else{if("undefined"!==typeof q.data("irl")){return b(g("#"+q.data("irl")))}}}}}return null};g.open=function(r,q){var p;if("undefined"!=typeof q){p=g.extend(true,{},f,q)}else{p=f}g(p.container).on("click",r,function(t){h(t,p)}).on("click","#"+p.browser.name+" ."+p.browser.closure.name,function(t){if(p.browser.closure.enable){t.currentTab=g(this).parent();if(g(t.currentTab).children("iframe").length){p.type=c.type.iframe}else{p.type=c.type.ajax}o(t,p)}}).on("click",function(t){if(p.browser.outerClosure){k(t,r,p)}});if(p.autoload){var s=g.Event("click");s.currentTarget=g(r).filter(":first");h(s,p)}}})(jQuery);